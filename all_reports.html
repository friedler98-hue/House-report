<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>כל התקלות</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
<nav class="container py-3 d-flex gap-3">
  <a href="./index.html">דף הבית</a>
  <a href="./all_reports.html">כל התקלות</a>
</nav>

<div class="container">
  <h3 class="mb-2">כל התקלות במערכת</h3>
  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-sm btn-outline-secondary" data-f="הכול">הכול</button>
    <button class="btn btn-sm btn-outline-danger" data-f="פתוחה">תקלות פתוחות</button>
    <button class="btn btn-sm btn-outline-warning" data-f="בטיפול">תקלות בטיפול</button>
    <button class="btn btn-sm btn-outline-success" data-f="טופלה">תקלות שטופלו</button>
  </div>
  <div id="list"></div>
</div>

<script src="./app.js"></script>
<script>
  const listDiv = document.getElementById("list");
  let filter = "הכול";

  function badge(status){
    const map = {"פתוחה":"bg-danger","בטיפול":"bg-warning text-dark","טופלה":"bg-success"};
    return map[status] || "bg-secondary";
  }

  async function load(){
    listDiv.innerHTML = `<div class="small-muted">טוען...</div>`;
    // “כל המערכת” = בלי site
    const res = await apiGetList("");
    if(!res.ok){ listDiv.innerHTML = `<div class="alert alert-warning">${res.error||"שגיאה"}</div>`; return; }

    let rows = (res.data||[]).slice().reverse();
    if(filter !== "הכול"){
      rows = rows.filter(r => String(r.status||"") === filter);
    }

    if(!rows.length){ listDiv.innerHTML = `<div class="small-muted">אין תוצאות.</div>`; return; }

    listDiv.innerHTML = "";
    rows.forEach(r=>{
      const status = String(r.status||"פתוחה");
      listDiv.appendChild(el(`
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-bold">${r.site||""} • ${r.type||""} • ${r.item||""}</div>
                <div class="small-muted">${r.area||""} • ${fmt(r.timestamp)}</div>
                <div class="mt-1">${r.desc||""}</div>
              </div>
              <span class="badge badge-status ${badge(status)}">${status}</span>
            </div>
          </div>
        </div>
      `));
    });
  }

  document.querySelectorAll("button[data-f]").forEach(b=>{
    b.onclick = ()=>{ filter = b.getAttribute("data-f"); load(); };
  });

  load();
</script>
</body>
</html>
