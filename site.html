<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>דשבורד</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
<nav class="container py-3 d-flex gap-3">
  <a href="./index.html">דף הבית</a>
  <a href="./all_reports.html">כל התקלות</a>
</nav>

<div class="container">
  <h3 class="mb-1" id="title"></h3>
  <div class="small-muted mb-3">דיווח תקלה חדשה + צפייה בתקלות של המתקן</div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <label class="form-label">אזור</label>
          <input class="form-control" id="area" placeholder="לדוגמה: סלון / מטבח">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">סוג</label>
          <select class="form-select" id="type">
            <option>תקלה</option>
            <option>חוסר</option>
            <option>ניקיון</option>
            <option>אחר</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">דחיפות</label>
          <select class="form-select" id="urgency">
            <option>רגיל</option>
            <option>דחוף</option>
            <option>מיידי</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">פריט</label>
          <input class="form-control" id="item" placeholder="לדוגמה: מזגן / נורה">
        </div>
        <div class="col-12 col-md-8">
          <label class="form-label">תיאור</label>
          <input class="form-control" id="desc" placeholder="מה קרה / מה חסר">
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" id="btnSend">שלח דיווח</button>
        <div class="small-muted" id="msg"></div>
      </div>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="m-0">תקלות במתקן</h5>
    <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">רענן</button>
  </div>

  <div id="list"></div>
</div>

<script src="./app.js"></script>
<script>
  const site = qs("site") || "";
  document.getElementById("title").textContent = `מתקן: ${site}`;
  const listDiv = document.getElementById("list");
  const msg = document.getElementById("msg");

  function badge(status){
    const map = {
      "פתוחה":"bg-danger",
      "בטיפול":"bg-warning text-dark",
      "טופלה":"bg-success"
    };
    return map[status] || "bg-secondary";
  }

  async function load(){
    listDiv.innerHTML = `<div class="small-muted">טוען...</div>`;
    const res = await apiGetList(site);
    if(!res.ok){ listDiv.innerHTML = `<div class="alert alert-warning">${res.error||"שגיאה"}</div>`; return; }

    const rows = (res.data||[]).slice().reverse();
    if(!rows.length){ listDiv.innerHTML = `<div class="small-muted">אין דיווחים עדיין.</div>`; return; }

    listDiv.innerHTML = "";
    rows.forEach(r=>{
      const status = String(r.status||"פתוחה");
      const card = el(`
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-bold">${r.type||""} • ${r.item||""}</div>
                <div class="small-muted">${r.area||""} • ${fmt(r.timestamp)}</div>
                <div class="mt-1">${r.desc||""}</div>
              </div>
              <span class="badge badge-status ${badge(status)}">${status}</span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-outline-warning" data-s="בטיפול">בטיפול</button>
              <button class="btn btn-sm btn-outline-success" data-s="טופלה">טופלה</button>
              <button class="btn btn-sm btn-outline-danger" data-s="פתוחה">פתוחה</button>
            </div>
          </div>
        </div>
      `);
      card.querySelectorAll("button[data-s]").forEach(b=>{
        b.onclick = async ()=>{
          const next = b.getAttribute("data-s");
          const ans = await apiSetStatus(String(r.id||""), next);
          if(!ans.ok){ alert(ans.error||"שגיאה"); return; }
          await load();
        };
      });
      listDiv.appendChild(card);
    });
  }

  document.getElementById("btnRefresh").onclick = load;

  document.getElementById("btnSend").onclick = async ()=>{
    msg.textContent = "שולח...";
    const payload = {
      site,
      area: document.getElementById("area").value.trim(),
      type: document.getElementById("type").value,
      item: document.getElementById("item").value.trim(),
      desc: document.getElementById("desc").value.trim(),
      urgency: document.getElementById("urgency").value,
      status: "פתוחה",
      imageUrl: ""
    };
    const res = await apiCreate(payload);
    if(!res.ok){ msg.textContent = res.error||"שגיאה"; return; }
    msg.textContent = "נשלח ✅";
    ["area","item","desc"].forEach(id=>document.getElementById(id).value="");
    await load();
    setTimeout(()=>msg.textContent="",1500);
  };

  load();
</script>
</body>
</html>
